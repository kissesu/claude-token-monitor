/**
 * @file release.yml
 * @description GitHub Actions å‘å¸ƒå·¥ä½œæµ - è‡ªåŠ¨ç‰ˆæœ¬å‘å¸ƒå’Œå¤šå¹³å°é•œåƒæ„å»º
 * @author Atlas.oi
 * @date 2026-01-07
 *
 * å®‰å…¨è¯´æ˜ï¼š
 * - ä¸ç›´æ¥å¤„ç† git commit messagesï¼ˆä¸å—ä¿¡ä»»çš„è¾“å…¥ï¼‰
 * - ä½¿ç”¨ç¯å¢ƒå˜é‡é¿å…å‘½ä»¤æ³¨å…¥
 * - Release notes é€šè¿‡ GitHub UI æ‰‹åŠ¨ç¼–è¾‘
 */

name: Release

on:
  push:
    tags:
      - 'v*.*.*'

# ============================================
# ç¯å¢ƒå˜é‡é…ç½®
# ============================================
env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # ============================================
  # åˆ›å»º GitHub Release
  # ============================================
  create-release:
    name: åˆ›å»º GitHub Release
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: æå–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION_NUMBER=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: åˆ›å»º Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          RELEASE_VERSION: ${{ steps.version.outputs.VERSION }}
          RELEASE_VERSION_NUMBER: ${{ steps.version.outputs.VERSION_NUMBER }}
          RELEASE_REPO: ${{ github.repository }}
          RELEASE_REGISTRY: ${{ env.REGISTRY }}
        with:
          tag_name: ${{ steps.version.outputs.VERSION }}
          release_name: Release ${{ steps.version.outputs.VERSION }}
          body: |
            ## Claude Token Monitor ${{ steps.version.outputs.VERSION }}

            ### Docker é•œåƒ

            ```bash
            # æ‹‰å–åç«¯é•œåƒ
            docker pull ${{ env.REGISTRY }}/${{ github.repository }}-backend:${{ steps.version.outputs.VERSION_NUMBER }}

            # æ‹‰å–å‰ç«¯é•œåƒ
            docker pull ${{ env.REGISTRY }}/${{ github.repository }}-frontend:${{ steps.version.outputs.VERSION_NUMBER }}

            # ä½¿ç”¨ docker-compose å¿«é€Ÿå¯åŠ¨
            curl -o docker-compose.yml https://raw.githubusercontent.com/${{ github.repository }}/${{ steps.version.outputs.VERSION }}/docker-compose.yml
            docker compose up -d
            ```

            ### ä½¿ç”¨è¯´æ˜

            è¯¦ç»†ä½¿ç”¨è¯´æ˜è¯·å‚é˜… [README.md](https://github.com/${{ github.repository }}/blob/${{ steps.version.outputs.VERSION }}/README.md)

            ### å˜æ›´æ—¥å¿—

            è¯·åœ¨æ­¤å¤„æ‰‹åŠ¨æ·»åŠ å˜æ›´å†…å®¹ï¼Œæˆ–æŸ¥çœ‹ [å®Œæ•´æäº¤å†å²](https://github.com/${{ github.repository }}/compare/${{ steps.version.outputs.VERSION }}...main)
          draft: true
          prerelease: false

  # ============================================
  # æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
  # ============================================
  build-and-push:
    name: æ„å»ºå¹¶æ¨é€ Docker é•œåƒ
    runs-on: ubuntu-latest
    needs: create-release
    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        platform:
          - linux/amd64
          - linux/arm64

    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4

      - name: æå–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "VERSION_NUMBER=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: è®¾ç½® QEMU
        uses: docker/setup-qemu-action@v3

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: æå– Docker å…ƒæ•°æ®ï¼ˆåç«¯ï¼‰
        id: meta-backend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-backend
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: æ„å»ºå¹¶æ¨é€åç«¯é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./docker/Dockerfile
          platforms: ${{ matrix.platform }}
          push: true
          tags: ${{ steps.meta-backend.outputs.tags }}
          labels: ${{ steps.meta-backend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: æå– Docker å…ƒæ•°æ®ï¼ˆå‰ç«¯ï¼‰
        id: meta-frontend
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}-frontend
          tags: |
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=semver,pattern={{major}}
            type=raw,value=latest

      - name: æ„å»ºå¹¶æ¨é€å‰ç«¯é•œåƒ
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          platforms: ${{ matrix.platform }}
          push: true
          tags: ${{ steps.meta-frontend.outputs.tags }}
          labels: ${{ steps.meta-frontend.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ============================================
  # å‘å¸ƒæˆåŠŸé€šçŸ¥
  # ============================================
  release-success:
    name: å‘å¸ƒæˆåŠŸ
    runs-on: ubuntu-latest
    needs: [create-release, build-and-push]
    if: success()

    steps:
      - name: æå–ç‰ˆæœ¬ä¿¡æ¯
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT

      - name: è¾“å‡ºæˆåŠŸæ¶ˆæ¯
        env:
          RELEASE_VERSION: ${{ steps.version.outputs.VERSION }}
          RELEASE_REPO: ${{ github.repository }}
        run: |
          echo "âœ… ç‰ˆæœ¬ ${RELEASE_VERSION} å‘å¸ƒæˆåŠŸï¼"
          echo "- GitHub Release: âœ…"
          echo "- Docker é•œåƒï¼ˆlinux/amd64ï¼‰: âœ…"
          echo "- Docker é•œåƒï¼ˆlinux/arm64ï¼‰: âœ…"
          echo ""
          echo "ğŸ”— æŸ¥çœ‹å‘å¸ƒ: https://github.com/${RELEASE_REPO}/releases/tag/${RELEASE_VERSION}"
