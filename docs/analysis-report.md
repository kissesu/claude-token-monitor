/**
 * @file analysis-report.md
 * @description Claude Token Monitor éœ€æ±‚åˆ†æä¸æ¶æ„è®¾è®¡æŠ¥å‘Š
 * @author Atlas.oi
 * @date 2026-01-06
 */

# Claude Token Monitor - éœ€æ±‚åˆ†æä¸æ¶æ„è®¾è®¡æŠ¥å‘Š

## ä¸€ã€é¡¹ç›®èƒŒæ™¯

### 1.1 éœ€æ±‚æ¥æº

ç”¨æˆ·å¸Œæœ›æ„å»ºä¸€ä¸ªå®šåˆ¶çš„ Claude Code æœ¬åœ°ç»Ÿè®¡æ•°æ®è¯»å–å™¨ï¼Œç”¨äºç›‘æ§ token ä½¿ç”¨æƒ…å†µã€ç¼“å­˜å‘½ä¸­ç‡ã€è´¹ç”¨ä¼°ç®—ç­‰å…³é”®æŒ‡æ ‡ã€‚

### 1.2 æ•°æ®æ¥æº

æ‰€æœ‰æ•°æ®å‡æ¥è‡ª Claude Code æœ¬åœ°å­˜å‚¨ç›®å½• `~/.claude/`ï¼Œæ— éœ€ç½‘ç»œè¯·æ±‚æˆ–ç¬¬ä¸‰æ–¹æœåŠ¡ä¾èµ–ã€‚

---

## äºŒã€æ•°æ®æºæ¶æ„åˆ†æ

### 2.1 æ ¸å¿ƒæ•°æ®æ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | ç”¨é€” | åˆ·æ–°æœºåˆ¶ | æ•°æ®æ ¼å¼ |
|----------|------|----------|----------|
| `~/.claude/stats-cache.json` | èšåˆç»Ÿè®¡æ•°æ® | ä¼šè¯ç»“æŸæ—¶æ›´æ–° | JSON |
| `~/.claude/projects/*/*.jsonl` | å®æ—¶ä¼šè¯æ—¥å¿— | æ¯æ¡æ¶ˆæ¯å³æ—¶å†™å…¥ | JSONL |
| `~/.claude/byebyecode/cache/usage.json` | API é…é¢ç¼“å­˜ | æ‰‹åŠ¨è§¦å‘ | JSON |

### 2.2 stats-cache.json ç»“æ„

```json
{
  "version": 1,
  "lastComputedDate": "2026-01-05",
  "totalSessions": 155,
  "totalMessages": 9353,
  "firstSessionDate": "2026-01-03T15:14:40.122Z",
  "dailyActivity": [
    {
      "date": "2026-01-04",
      "messageCount": 5820,
      "sessionCount": 100,
      "toolCallCount": 940
    }
  ],
  "dailyModelTokens": [
    {
      "date": "2026-01-04",
      "tokensByModel": {
        "claude-opus-4-5-thinking": 19654175,
        "claude-sonnet-4-5-20250929": 152465
      }
    }
  ],
  "modelUsage": {
    "claude-opus-4-5-20251101": {
      "inputTokens": 142587,
      "outputTokens": 308870,
      "cacheReadInputTokens": 215563256,
      "cacheCreationInputTokens": 28223059,
      "webSearchRequests": 0,
      "costUSD": 0,
      "contextWindow": 0
    }
  },
  "hourCounts": {
    "16": 24,
    "17": 16,
    "1": 12
  },
  "longestSession": {
    "sessionId": "f694c480-bee8-4c8c-a156-de69459d69e5",
    "duration": 47097859,
    "messageCount": 105
  }
}
```

### 2.3 å…³é”®æŒ‡æ ‡è¯´æ˜

| æŒ‡æ ‡ | å­—æ®µå | è¯´æ˜ |
|------|--------|------|
| ç›´æ¥è¾“å…¥ Token | `inputTokens` | æœªå‘½ä¸­ç¼“å­˜çš„è¾“å…¥ token |
| è¾“å‡º Token | `outputTokens` | æ¨¡å‹ç”Ÿæˆçš„ token |
| ç¼“å­˜å‘½ä¸­ Token | `cacheReadInputTokens` | ä»ç¼“å­˜è¯»å–çš„ token |
| ç¼“å­˜åˆ›å»º Token | `cacheCreationInputTokens` | å†™å…¥ç¼“å­˜çš„ token |

### 2.4 ç¼“å­˜å‘½ä¸­ç‡è®¡ç®—å…¬å¼

```python
total_input = inputTokens + cacheReadInputTokens + cacheCreationInputTokens
hit_rate = (cacheReadInputTokens / total_input) * 100
```

### 2.5 è´¹ç”¨ä¼°ç®—å…¬å¼

åŸºäº Anthropic å®˜æ–¹å®šä»·ï¼ˆ2025 å¹´ 1 æœˆï¼‰ï¼š

| æ¨¡å‹ | è¾“å…¥ä»·æ ¼ | è¾“å‡ºä»·æ ¼ | ç¼“å­˜è¯»å– | ç¼“å­˜å†™å…¥ |
|------|----------|----------|----------|----------|
| Claude Opus 4.5 | $15/M | $75/M | $1.5/M | $18.75/M |
| Claude Sonnet 4.5 | $3/M | $15/M | $0.3/M | $3.75/M |
| Claude Haiku 4.5 | $0.8/M | $4/M | $0.08/M | $1/M |

```python
cost = (input_tokens * input_price +
        output_tokens * output_price +
        cache_read * cache_read_price +
        cache_create * cache_write_price) / 1_000_000
```

---

## ä¸‰ã€ä¸‰ç§å®ç°æ–¹æ¡ˆæ¦‚è¿°

### 3.1 Statusline æ–¹æ¡ˆ

**å®šä½**ï¼šç»ˆç«¯é›†æˆçš„è½»é‡çº§çŠ¶æ€æ æ˜¾ç¤º

**æŠ€æœ¯æ ˆæ¨è**ï¼š
- é¦–é€‰ï¼šGo + bubbletea/lipgloss
- å¤‡é€‰ï¼šRust + ratatui

**æ˜¾ç¤ºæ ¼å¼ç¤ºä¾‹**ï¼š
```
ó°š Opus | âš¡ 45.2% | ğŸ’¾ 98.3% | ğŸ’° $12.34 | â±ï¸ 2h15m
```

### 3.2 Desktop æ–¹æ¡ˆ

**å®šä½**ï¼šè·¨å¹³å°æ¡Œé¢åº”ç”¨ï¼Œæ”¯æŒç³»ç»Ÿæ‰˜ç›˜å’Œå¯è§†åŒ–å›¾è¡¨

**æŠ€æœ¯æ ˆæ¨è**ï¼š
- é¦–é€‰ï¼šTauri (Rust + WebView)
- å¤‡é€‰ï¼šElectron

**æ ¸å¿ƒåŠŸèƒ½**ï¼š
- ç³»ç»Ÿæ‰˜ç›˜å¿«é€ŸæŸ¥çœ‹
- ä¸»çª—å£ä»ªè¡¨æ¿
- å®æ—¶æ‚¬æµ®çª—
- å†å²æ•°æ®å›¾è¡¨

### 3.3 Web UI Docker æ–¹æ¡ˆ

**å®šä½**ï¼šå®¹å™¨åŒ– Web åº”ç”¨ï¼Œæ”¯æŒè¿œç¨‹è®¿é—®

**æŠ€æœ¯æ ˆæ¨è**ï¼š
- å‰ç«¯ï¼šSvelte + Vite + TypeScript + Layerchart
- åç«¯ï¼šPython aiohttp + WebSocket
- æ•°æ®åº“ï¼šSQLite
- éƒ¨ç½²ï¼šDocker å•å®¹å™¨

**æ¶æ„å›¾**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Docker Container               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Svelte    â”‚â—„â”€â”€â–ºâ”‚  aiohttp API  â”‚   â”‚
â”‚  â”‚  Frontend   â”‚    â”‚  + WebSocket  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                            â”‚            â”‚
â”‚                     â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚                     â”‚   SQLite    â”‚     â”‚
â”‚                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚ Volume Mount (readonly)
              â–¼
         ~/.claude/
```

---

## å››ã€æ•°æ®åˆ·æ–°ç­–ç•¥

### 4.1 å®æ—¶æ•°æ®ï¼ˆ< 1s å»¶è¿Ÿï¼‰

- ç›‘å¬ `.jsonl` æ–‡ä»¶å˜åŒ–ï¼ˆinotify/fseventsï¼‰
- å¢é‡è§£ææ–°å¢è¡Œ
- WebSocket æ¨é€æ›´æ–°

### 4.2 èšåˆæ•°æ®ï¼ˆä¼šè¯çº§å»¶è¿Ÿï¼‰

- å®šæ—¶è½®è¯¢ `stats-cache.json`ï¼ˆå»ºè®® 30sï¼‰
- æ£€æµ‹ `lastComputedDate` å˜åŒ–
- è§¦å‘å…¨é‡åˆ·æ–°

### 4.3 å†å²æ•°æ®

- è§£ææ‰€æœ‰ `.jsonl` æ–‡ä»¶æ„å»ºå†å²
- å­˜å‚¨åˆ° SQLite é¿å…é‡å¤è§£æ
- æ”¯æŒæ—¶é—´èŒƒå›´æŸ¥è¯¢

---

## äº”ã€æŠ€æœ¯é€‰å‹å¯¹æ¯”

### 5.1 Statusline æŠ€æœ¯å¯¹æ¯”

| ç»´åº¦ | Go | Rust | Python | Node.js |
|------|-----|------|--------|---------|
| äºŒè¿›åˆ¶å¤§å° | 5-10MB | 2-5MB | N/A (éœ€è§£é‡Šå™¨) | N/A |
| å¯åŠ¨é€Ÿåº¦ | <50ms | <30ms | 200-500ms | 300-600ms |
| å†…å­˜å ç”¨ | 5-15MB | 3-10MB | 30-50MB | 50-100MB |
| å¼€å‘æ•ˆç‡ | é«˜ | ä¸­ | æœ€é«˜ | é«˜ |
| è·¨å¹³å° | ä¼˜ç§€ | ä¼˜ç§€ | éœ€æ‰“åŒ… | éœ€æ‰“åŒ… |
| æ¨èåº¦ | â­â­â­â­â­ | â­â­â­â­ | â­â­ | â­â­ |

### 5.2 Desktop æŠ€æœ¯å¯¹æ¯”

| ç»´åº¦ | Tauri | Electron | Qt/PySide6 |
|------|-------|----------|------------|
| æ‰“åŒ…ä½“ç§¯ | 3-10MB | 150-200MB | 50-100MB |
| å†…å­˜å ç”¨ | 50-100MB | 200-500MB | 100-200MB |
| å¯åŠ¨é€Ÿåº¦ | <2s | 3-5s | 2-4s |
| Web æŠ€æœ¯æ ˆ | æ”¯æŒ | æ”¯æŒ | ä¸æ”¯æŒ |
| ç³»ç»Ÿ API | å®Œæ•´ | å®Œæ•´ | å®Œæ•´ |
| æ¨èåº¦ | â­â­â­â­â­ | â­â­â­ | â­â­â­ |

### 5.3 Web UI æŠ€æœ¯å¯¹æ¯”

| ç»´åº¦ | Svelte + aiohttp | Vue 3 + aiohttp | React + FastAPI |
|------|------------------|-----------------|-----------------|
| æ‰“åŒ…ä½“ç§¯ | æœ€å° (~5KB) | ä¸­ (~30KB) | è¾ƒå¤§ (~80KB) |
| è¿è¡Œæ—¶å¼€é”€ | æ—  | æœ‰ | æœ‰ |
| å¼€å‘æ•ˆç‡ | é«˜ | é«˜ | é«˜ |
| å›¾è¡¨ç”Ÿæ€ | Layerchart | ECharts | Recharts |
| é€‚åˆä»ªè¡¨æ¿ | æœ€ä½³ | è‰¯å¥½ | è‰¯å¥½ |
| æ¨èåº¦ | â­â­â­â­â­ | â­â­â­â­ | â­â­â­ |

---

## å…­ã€åŠŸèƒ½éœ€æ±‚çŸ©é˜µ

| åŠŸèƒ½ | Statusline | Desktop | Web UI |
|------|:----------:|:-------:|:------:|
| å®æ—¶ Token æ˜¾ç¤º | âœ… | âœ… | âœ… |
| ç¼“å­˜å‘½ä¸­ç‡ | âœ… | âœ… | âœ… |
| è´¹ç”¨ä¼°ç®— | âœ… | âœ… | âœ… |
| ä¼šè¯æ—¶é•¿ | âœ… | âœ… | âœ… |
| å†å²æ•°æ®æŸ¥çœ‹ | âŒ | âœ… | âœ… |
| è¶‹åŠ¿å›¾è¡¨ | âŒ | âœ… | âœ… |
| å¤šæ¨¡å‹å¯¹æ¯” | âš ï¸ æœ‰é™ | âœ… | âœ… |
| æ•°æ®å¯¼å‡º | âŒ | âœ… | âœ… |
| è¿œç¨‹è®¿é—® | âŒ | âŒ | âœ… |
| ç³»ç»Ÿæ‰˜ç›˜ | âŒ | âœ… | âŒ |
| é€šçŸ¥æé†’ | âŒ | âœ… | âœ… |
| ç»ˆç«¯é›†æˆ | âœ… | âŒ | âŒ |

---

## ä¸ƒã€éƒ¨ç½²æ¶æ„

### 7.1 Statusline éƒ¨ç½²

```bash
# å®‰è£…
curl -sSL https://install.example.com/claude-monitor | sh

# é…ç½® shell
echo 'eval "$(claude-monitor init bash)"' >> ~/.bashrc

# æˆ– tmux é›†æˆ
set -g status-right '#(claude-monitor --format tmux)'
```

### 7.2 Desktop éƒ¨ç½²

```bash
# macOS
brew install --cask claude-monitor

# Windows
winget install claude-monitor

# Linux
flatpak install claude-monitor
```

### 7.3 Web UI Docker éƒ¨ç½²

```yaml
# docker-compose.yml
version: '3.8'
services:
  claude-monitor:
    image: claude-monitor:latest
    ports:
      - "51888:51888"
    volumes:
      - ~/.claude:/data/.claude:ro
    environment:
      - TZ=Asia/Shanghai
    restart: unless-stopped
```

---

## å…«ã€å®‰å…¨è€ƒè™‘

### 8.1 æ•°æ®è®¿é—®

- æ‰€æœ‰æ•°æ®æ–‡ä»¶ä»¥åªè¯»æ¨¡å¼æŒ‚è½½
- ä¸ä¿®æ”¹ä»»ä½• Claude Code åŸå§‹æ–‡ä»¶
- æ•æ„Ÿæ•°æ®ï¼ˆå¦‚ API Keyï¼‰ä¸è¿›è¡ŒæŒä¹…åŒ–

### 8.2 ç½‘ç»œå®‰å…¨ï¼ˆWeb UIï¼‰

- é»˜è®¤ä»…ç›‘å¬ localhost
- æ”¯æŒ Basic Auth / API Token è®¤è¯
- å»ºè®®é€šè¿‡ VPN æˆ– SSH éš§é“è®¿é—®

### 8.3 å®¹å™¨å®‰å…¨

- ä½¿ç”¨é root ç”¨æˆ·è¿è¡Œ
- æœ€å°åŒ–åŸºç¡€é•œåƒï¼ˆAlpineï¼‰
- å®šæœŸæ›´æ–°ä¾èµ–

---

## ä¹ã€æ‰©å±•æ€§è®¾è®¡

### 9.1 æ’ä»¶ç³»ç»Ÿ

- è‡ªå®šä¹‰æŒ‡æ ‡è®¡ç®—
- è‡ªå®šä¹‰æ˜¾ç¤ºæ ¼å¼
- ç¬¬ä¸‰æ–¹æœåŠ¡é›†æˆï¼ˆPrometheusã€Grafanaï¼‰

### 9.2 å¤šè´¦æˆ·æ”¯æŒ

- æ”¯æŒå¤šä¸ª Claude é…ç½®ç›®å½•
- è´¦æˆ·åˆ‡æ¢ä¸å¯¹æ¯”

### 9.3 API å¯¼å‡º

- RESTful API
- Prometheus metrics endpoint
- Webhook é€šçŸ¥

---

## åã€å¼€å‘è·¯çº¿å›¾

### Phase 1ï¼šMVPï¼ˆ2 å‘¨ï¼‰

- [ ] æ•°æ®è§£ææ ¸å¿ƒåº“
- [ ] Statusline åŸºç¡€ç‰ˆæœ¬
- [ ] é…ç½®æ–‡ä»¶æ”¯æŒ

### Phase 2ï¼šå¯è§†åŒ–ï¼ˆ2 å‘¨ï¼‰

- [ ] Web UI ä»ªè¡¨æ¿
- [ ] åŸºç¡€å›¾è¡¨
- [ ] Docker éƒ¨ç½²

### Phase 3ï¼šæ¡Œé¢ç«¯ï¼ˆ3 å‘¨ï¼‰

- [ ] Tauri åº”ç”¨æ¡†æ¶
- [ ] ç³»ç»Ÿæ‰˜ç›˜
- [ ] è·¨å¹³å°æ‰“åŒ…

### Phase 4ï¼šå¢å¼ºï¼ˆæŒç»­ï¼‰

- [ ] å†å²æ•°æ®åˆ†æ
- [ ] æ’ä»¶ç³»ç»Ÿ
- [ ] å¤šè´¦æˆ·æ”¯æŒ

---

## é™„å½•

### A. å‚è€ƒèµ„æº

- [Claude Code å®˜æ–¹æ–‡æ¡£](https://docs.anthropic.com/claude-code)
- [Anthropic API å®šä»·](https://www.anthropic.com/pricing)
- [byebyecode é¡¹ç›®](https://github.com/example/byebyecode)

### B. æœ¯è¯­è¡¨

| æœ¯è¯­ | è¯´æ˜ |
|------|------|
| Token | æ¨¡å‹å¤„ç†çš„æœ€å°æ–‡æœ¬å•ä½ |
| Cache Hit | ç¼“å­˜å‘½ä¸­ï¼Œå¤ç”¨ä¹‹å‰çš„è®¡ç®—ç»“æœ |
| Context Window | æ¨¡å‹å•æ¬¡å¤„ç†çš„æœ€å¤§ token æ•° |
| JSONL | JSON Lines æ ¼å¼ï¼Œæ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡ |

---

*æ–‡æ¡£ç‰ˆæœ¬ï¼š1.0.0*
*æœ€åæ›´æ–°ï¼š2026-01-06*
