# ============================================
# @file docker-compose.dev.yml
# @description Claude Token Monitor 开发环境 Docker Compose 配置
# @author Atlas.oi
# @date 2026-01-07
#
# 开发环境特性：
# - 分离前后端服务便于独立调试
# - 源码目录挂载支持热重载
# - 开放所有必要端口
# - 不设置严格的资源限制
# ============================================

version: '3.8'

services:
  # ============================================
  # 后端开发服务
  # ============================================
  backend:
    build:
      context: .
      dockerfile: docker/Dockerfile.dev
    container_name: claude-monitor-backend-dev

    # 端口映射
    ports:
      - "51888:51888"

    # 环境变量
    environment:
      # Claude CLI 配置目录
      - CLAUDE_DIR=/claude
      # 数据库路径
      - DATABASE_PATH=/app/data/monitor.db
      # API 配置
      - API_PREFIX=/api/v1
      - BACKEND_PORT=51888
      # 开发模式配置
      - DEBUG=true
      - LOG_LEVEL=DEBUG
      # 数据库配置
      - DB_POOL_SIZE=5
      - DB_POOL_RECYCLE=3600
      # 监控配置
      - MONITOR_INTERVAL=60
      - MAX_HISTORY_DAYS=90
      # 时区设置
      - TZ=Asia/Shanghai
      # 热重载配置
      - WATCHFILES_FORCE_POLLING=true

    # 卷挂载（支持代码热重载）
    volumes:
      # 只读挂载 Claude CLI 配置目录
      - ${CLAUDE_DIR:-~/.claude}:/claude:ro

      # 挂载后端源码（支持热重载）
      - ./backend:/app/backend

      # 持久化数据目录
      - ./data:/app/data

      # 日志目录
      - ./logs:/app/logs

      # 导出文件目录
      - ./exports:/app/exports

    # 健康检查
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:51888/api/v1/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

    # 开发环境不自动重启（便于调试）
    restart: "no"

    # 网络配置
    networks:
      - monitor-dev-network

    # 启动命令（支持热重载）
    command: python -m backend.app.main --reload

  # ============================================
  # 前端开发服务
  # ============================================
  frontend:
    image: node:20-alpine
    container_name: claude-monitor-frontend-dev

    # 工作目录
    working_dir: /app

    # 端口映射（Vite 开发服务器）
    ports:
      - "51173:51173"

    # 环境变量
    environment:
      # Node 环境
      - NODE_ENV=development
      # Vite 配置
      - VITE_API_URL=http://localhost:51888/api/v1
      - VITE_PORT=51173
      # 时区设置
      - TZ=Asia/Shanghai

    # 卷挂载（支持代码热重载）
    volumes:
      # 挂载前端源码
      - ./frontend:/app

      # Node modules 使用命名卷（提高性能）
      - frontend-node-modules:/app/node_modules

    # 网络配置
    networks:
      - monitor-dev-network

    # 开发环境不自动重启
    restart: "no"

    # 安装依赖并启动开发服务器
    command: sh -c "npm install -g pnpm && pnpm install && pnpm run dev --host 0.0.0.0 --port 51173"

    # 依赖后端服务
    depends_on:
      - backend

# ============================================
# 网络配置
# ============================================
networks:
  monitor-dev-network:
    driver: bridge
    name: claude-monitor-dev-network

# ============================================
# 卷配置
# ============================================
volumes:
  # 前端 node_modules 命名卷（提高 I/O 性能）
  frontend-node-modules:
    name: claude-monitor-frontend-node-modules
