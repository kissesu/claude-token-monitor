# Dockerfile.dev
# Claude Token Monitor 开发环境 Dockerfile
# @author Atlas.oi
# @date 2026-01-07
#
# 开发环境特性：
# - 支持代码热重载
# - 挂载本地源码目录
# - 包含开发工具和调试依赖
# - 分离前后端服务便于独立调试

FROM python:3.11-alpine

# 设置元数据标签
LABEL maintainer="Atlas.oi" \
      version="1.0.0-dev" \
      description="Claude Token Monitor - 开发环境"

# 设置工作目录
WORKDIR /app

# 安装系统依赖和开发工具
RUN apk add --no-cache \
    curl \
    sqlite \
    ca-certificates \
    tzdata \
    gcc \
    musl-dev \
    python3-dev \
    libffi-dev \
    git \
    bash

# 设置时区
ENV TZ=Asia/Shanghai

# 创建非 root 用户
RUN addgroup -g 1000 appuser && \
    adduser -D -u 1000 -G appuser appuser

# 复制后端依赖文件
COPY backend/requirements.txt ./backend/
COPY backend/requirements-dev.txt* ./backend/

# 安装 Python 依赖（包括开发依赖）
RUN pip install --no-cache-dir -r backend/requirements.txt && \
    if [ -f backend/requirements-dev.txt ]; then \
        pip install --no-cache-dir -r backend/requirements-dev.txt; \
    fi

# 创建必要的目录
RUN mkdir -p /app/data /app/logs /app/exports && \
    chown -R appuser:appuser /app

# 切换到非 root 用户
USER appuser

# 设置环境变量
ENV PATH=/home/appuser/.local/bin:$PATH
ENV PYTHONPATH=/app
ENV PYTHONUNBUFFERED=1
ENV DEBUG=true

# 暴露端口
EXPOSE 51888

# 健康检查
HEALTHCHECK --interval=30s --timeout=3s --start-period=10s --retries=3 \
    CMD curl -f http://localhost:51888/api/v1/health || exit 1

# 启动命令（支持热重载）
# 注意：实际代码通过 docker-compose.dev.yml 挂载进来
CMD ["python", "-m", "backend.app.main", "--reload"]
